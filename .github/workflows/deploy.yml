name: CI/CD - Testes e Deploy

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:

permissions:
    contents: read
    pages: write
    id-token: write

concurrency:
    group: 'pages'
    cancel-in-progress: false

jobs:
    quality:
        name: Qualidade e Testes Unitários
        runs-on: ubuntu-latest

        steps:
            - name: Checkout do código
              uses: actions/checkout@v4

            - name: Configurar Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Instalar dependências
              run: npm install

            - name: Executar ESLint
              run: npm run lint

            - name: Verificar formatação Prettier
              run: npm run format:check

            - name: Executar testes unitários com cobertura
              run: npm run test:coverage

    e2e:
        name: Testes E2E (Cypress)
        runs-on: ubuntu-latest
        needs: quality

        steps:
            - name: Checkout do código
              uses: actions/checkout@v4

            - name: Configurar Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Instalar dependências
              run: npm install

            - name: Executar testes Cypress
              uses: cypress-io/github-action@v6
              with:
                  start: npm run dev
                  wait-on: 'http://localhost:3000'
                  wait-on-timeout: 120
                  browser: chrome
                  config-file: cypress.config.cjs

            - name: Upload screenshots em caso de falha
              uses: actions/upload-artifact@v4
              if: failure()
              with:
                  name: cypress-screenshots
                  path: testes/e2e/screenshots

            - name: Upload vídeos dos testes
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: cypress-videos
                  path: testes/e2e/videos

    deploy:
        name: Deploy para GitHub Pages
        runs-on: ubuntu-latest
        needs: [quality, e2e]
        # Só faz deploy em push na main, não em PRs
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        steps:
            - name: Checkout do código
              uses: actions/checkout@v4

            - name: Configurar GitHub Pages
              uses: actions/configure-pages@v4

            - name: Upload do artefato
              uses: actions/upload-pages-artifact@v3
              with:
                  path: './src'

            - name: Deploy para GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
